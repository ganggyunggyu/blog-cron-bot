# Node-Cron 사용 가이드

node-cron을 사용하여 매일 오전 8시에 자동으로 실행되는 크론잡입니다.

## 📋 워크플로우 개요

크론잡은 3단계로 실행됩니다:

1. **📤 Step 1: Sheet → DB 동기화** (`GET /api/cron/sync-all`)
   - Google Sheets의 모든 데이터를 MongoDB로 가져옵니다
   - 기존 데이터 삭제 후 새 데이터 삽입

2. **🔍 Step 2: 크롤링 및 노출 체크**
   - 네이버 검색 결과 크롤링
   - 블로그 노출 여부 확인
   - MongoDB에 결과 업데이트

3. **📥 Step 3: DB → Sheet 적용** (`GET /api/cron/import-all`)
   - 노출 체크 결과를 Google Sheets에 반영
   - visibility 필드만 업데이트

> ⚠️ **중요**: 3단계는 **반드시 순서대로** 실행됩니다. 중간에 실패하면 전체 워크플로우가 중단됩니다.

---

## 🚀 빠른 시작

### 사전 준비

1. **Sheet App 실행** (3000포트 필수)
   ```bash
   # Sheet App 프로젝트에서
   pnpm dev
   ```

2. **환경 변수 설정** (`.env`)
   ```env
   MONGODB_URI=mongodb+srv://...
   SHEET_APP_URL=http://localhost:3000  # Sheet App URL (기본값)
   ```

### 1. 크론 스케줄러 실행

```bash
pnpm cron
```

### 2. 테스트 실행 (5분 뒤)

```bash
pnpm cron:test
```

현재 시간 기준 **5분 뒤**에 실행됩니다.

**다른 시간으로 테스트:**
```bash
# 3분 뒤
TEST_DELAY_MINUTES=3 pnpm cron

# 10분 뒤
TEST_DELAY_MINUTES=10 pnpm cron

# 1분 뒤
TEST_DELAY_MINUTES=1 pnpm cron
```

---

## 📊 실행 예시

### 정상 모드 (pnpm cron)

```bash
$ pnpm cron

🚀 크론 스케줄러 시작
⏰ 스케줄: 0 8 * * * (매일 오전 8시)
📅 현재 시간: 2024. 11. 13. 오후 1:00:00
🌐 Sheet App URL: http://localhost:3000
⏳ 대기 중...

# 오전 8시까지 대기...
```

### 테스트 모드 (pnpm cron:test)

```bash
$ pnpm cron:test

🚀 크론 스케줄러 시작
⏰ 스케줄: 5 13 * * * (테스트 모드: 5분 뒤 (오후 01:05))
📅 현재 시간: 2024. 11. 13. 오후 1:00:00
🌐 Sheet App URL: http://localhost:3000
🧪 테스트 실행 예정: 2024. 11. 13. 오후 1:05:00
⏳ 대기 중...

# 5분 뒤 자동 실행...

🤖 [2024. 11. 13. 오후 1:05:00] 크론잡 시작
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📤 [Step 1/3] 전체 데이터 DB로 내보내기...
✅ [Step 1/3] 완료
   - 삭제: 150개
   - 삽입: 155개

🔍 [Step 2/3] 크롤링 및 노출 체크 시작...
[1/155] 스마일라식 ✅
...

📥 [Step 3/3] 노출 현황 시트에 적용...
✅ [Step 3/3] 완료
   - 업데이트: 155개

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ [CRON] 전체 워크플로우 완료!
⏱️  소요 시간: 330.5초
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

매일 오전 8시에 자동으로 실행됩니다! 🎉
